<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Ora Session Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: "Audiowide", sans-serif;
        background: linear-gradient(145deg, #0a0a0a, #1a1a1a);
        color: white;
        padding: 2rem;
        text-align: center;
      }
      h1 {
        margin-bottom: 1rem;
        text-shadow: 0 0 10px #c084fc;
      }
      .info {
        margin-bottom: 2rem;
        color: #bbb;
        font-size: 0.95rem;
      }
      .summary {
        background: #1a1a1a;
        padding: 1.5rem;
        border-radius: 20px;
        margin: 1rem auto;
        width: 90%;
        max-width: 700px;
        box-shadow: 0 0 15px #9b5de5;
        text-align: left;
      }
      button {
        margin-top: 1rem;
        background-color: #c084fc;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 0.8rem 1.5rem;
        cursor: pointer;
        font-weight: bold;
        font-family: "Audiowide", sans-serif;
      }
      button:hover {
        background-color: #9b5de5;
      }
      .back-button {
        background-color: transparent;
        color: #c084fc;
        border: 1px solid #c084fc;
        margin-top: 2rem;
      }
      .back-button:hover {
        background-color: #c084fc;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1 id="sessionName">Loading...</h1>

    <div class="info" id="meetingInfo">Loading...</div>

    <div class="summary" id="summaryText">
      <h3>Loading transcript...</h3>
    </div>

    <button onclick="downloadSummary()">Download Full Transcript (TXT)</button>
    <br><br>
    <button class="back-button" onclick="goBackToDashboard()">Back to Dashboard</button>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyC_E91yz5ARm3vbq_55JfHjfYr0FJ3oB_o",
        authDomain: "ora-tech-79eae.firebaseapp.com",
        projectId: "ora-tech-79eae",
        storageBucket: "ora-tech-79eae.firebasestorage.app",
        messagingSenderId: "62701837639",
        appId: "1:62701837639:web:42c9ec787844fa4de9c062",
        measurementId: "G-DSE8BTDQQH"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth();

      const sessionId = localStorage.getItem("selectedSession");
      const sessionDate = localStorage.getItem("selectedSessionDate") || "Unknown";
      const sessionTime = localStorage.getItem("selectedSessionTime") || "Unknown";

      document.getElementById("meetingInfo").innerHTML = `
        Date: <strong>${sessionDate}</strong><br>
        Time: <strong>${sessionTime}</strong>
      `;

      onAuthStateChanged(auth, async (user) => {
        if (!user || !sessionId) {
          alert("User not authenticated or session ID missing.");
          window.location.href = "dashboard.html";
          return;
        }

        const docRef = doc(db, `users/${user.uid}/meetings/${sessionId}`);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();

          document.getElementById("sessionName").textContent = data.sessionName || "No session name found";
          document.getElementById("summaryText").innerHTML = `
            <h3>Full Transcript</h3>
            <pre style="white-space: pre-wrap;">${data.fullTranscript}</pre>
          `;

          window.downloadSummary = function () {
            const blob = new Blob([data.fullTranscript], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${sessionId}-Transcript.txt`;
            link.click();
          };

        } else {
          document.getElementById("summaryText").innerHTML = `<p>Transcript not found in Firebase.</p>`;
        }
      });

      window.goBackToDashboard = function () {
        window.location.href = "dashboard.html";
      };
    </script>
  </body>
</html>